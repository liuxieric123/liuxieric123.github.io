---
layout: post
titile: 2016-06-27查询校网上的学术会议并发邮件通知
date: 2016-06-27 00:05:00.000000000 +09:00
---

有这样一个想法，搭建起某个服务使得可以自动监测校网上学术会议通知，如果有更新的话则发送一封邮件通知使用这个服务的客户。这个想法存在了大概两个月了。
#一开始的想法
最一开始的时候是看到了网上有人使用Python进行网络爬虫，获取网页内容，这个点子激起了我的这个思路。但是实现起来并不顺利，一是我不懂Python语法，二是整个流程我搞得不清楚。当时的认识是，构造请求然后发送，得到内容，再对内容进行解析，得到自己想要的。但是中间的细节未弄明白，比如如何对收到的内容进行解析，当时的想法是通过正则表达式，所以转而去学习正则表达式，以致于这个想法的实现被拖延。但在这中间，基本上弄明白了发邮件的过程，就是需要一个库，或者是插件，我只需要连接到smtp服务器，登录进去就可以发送邮件了。
#学习了JS后
在新浪实习开始接触JS后，对网页的理解更多了，一开始的想法在实现上有了新的思路。JS天生就是用来处理网页内容的，它可以很方便的解析HTML,这样得到网页内容然后解析进行提取就显得很容易了。当然其他的细节的实现，JS也支持的很好，使用nodejs可以很方便的搭建起一个服务器，我可以在树莓派上部署服务（nodejs在树莓派上运行良好），node下有专门解析HTML的插件（或者叫包），以及发送邮件的插件（或者叫包）。基于这些基础，我开始构建这个服务。
#碰到的问题
整个流程很顺畅，大概用了四个小时，就写好了整个框架，并且可以收到邮件，但是这中间出现了个致命的问题，那就是在发现有更新后，我需要对更新的部分进行内容读取，整个读取的过程是获取每一条内容中的链接，然后发送请求，再得到内容。我使用循环来实现这个过程，但由于Js的异步特性，使得多次请求发出，循环结束，但网页的内容没有得到，整个流程就已经执行结束了。所以如果有更新，我也不会在邮件中收到更新的内容。所以我需要解决的问题是讲for循环中的异步过程变成同步，或者是在确定内容返回之后再执行后续的步骤。
#解决方法
通过查资料，发现说解决Js异步的方法是闭包，发现这并不合适我的场景，闭包是用来获取获取局部变量的内部函数，因为一般外部无法获取内部函数的变量（除非在内部函数中定义了全局变量，如不适用var定义的变量）。这并不能解决我的问题。解决方法是，在请求的回调函数中判断循环的次数，如果到达了最后一次则执行后续的内容，这样后续的步骤就可以得到请求获取的网页内容。